# Mapbox Integration API Documentation

## Overview

This documentation covers the Mapbox integration within the Maly platform, specifically detailing how location services are implemented for event creation, location geocoding, and coordinate management. This guide is designed for iOS developers who need to integrate with the Maly backend APIs that utilize Mapbox services.

## Environment Setup

### Required Environment Variables

```bash
MAPBOX_API_KEY=your_mapbox_access_token_here
```

The Mapbox API key is required for all geocoding operations. Without this key, geocoding will be skipped and location coordinates will not be automatically generated.

## Mapbox Service Architecture

### Core Service: `mapboxService.ts`

The platform uses Mapbox's Geocoding API through the `@mapbox/mapbox-sdk` package to convert location strings into geographic coordinates.

#### Core Function: `getCoordinates(location: string)`

**Purpose**: Converts a location string (address, city name, landmark) into latitude and longitude coordinates.

**Parameters**:
- `location` (string): The location query string (e.g., "123 Main St, New York, NY", "San Francisco", "Times Square")

**Returns**:
```typescript
{
  longitude: number, // Geographic longitude (e.g., -122.4194)
  latitude: number   // Geographic latitude (e.g., 37.7749)
} | null
```

**Implementation Details**:
- Uses Mapbox Forward Geocoding API
- Limits results to 1 match (`limit: 1`)
- Returns `null` if geocoding fails or no results found
- Handles API errors gracefully with console logging

## Database Schema for Location Data

### Events Table Location Fields

```sql
CREATE TABLE events (
  -- ... other fields
  
  -- Location Information
  city VARCHAR NOT NULL,                          -- City name for filtering
  location VARCHAR NOT NULL,                      -- Specific venue/area name
  address VARCHAR,                                -- Exact street address (optional)
  
  -- Geographic Coordinates (Generated by Mapbox)
  latitude DECIMAL(10,7),                         -- Geographic latitude
  longitude DECIMAL(10,7),                        -- Geographic longitude
  
  -- ... other fields
);
```

**Field Descriptions**:
- **`city`**: Used for city-based filtering in the app UI
- **`location`**: Specific venue or area description within the city
- **`address`**: Complete street address when available
- **`latitude`/`longitude`**: Precise coordinates for mapping and proximity searches

## API Endpoints

### 1. Event Creation with Location

**Endpoint**: `POST /api/events`

**Content-Type**: `multipart/form-data` (supports file uploads)

**Authentication**: Required (Bearer token or session-based)

#### Request Body

**Required Location Fields**:
```json
{
  "city": "San Francisco",           // Required: City name
  "location": "SOMA District",       // Required: Specific venue/area
  "address": "123 Tech Street, SF"   // Optional: Full address
}
```

**Complete Example Request**:
```json
{
  "title": "Tech Networking Meetup",
  "description": "Join us for an evening of networking...",
  "city": "San Francisco",
  "location": "SOMA District",
  "address": "123 Technology Street, San Francisco, CA 94105",
  "date": "2024-03-15T19:00:00Z",
  "category": "Technology",
  "ticketType": "paid",
  "price": "25.00",
  "capacity": 50
}
```

#### Location Processing Logic

1. **Primary Geocoding**: If `address` field is provided, use it for Mapbox geocoding
2. **Fallback Geocoding**: If no `address`, use the `location` field value
3. **Coordinate Storage**: Successfully geocoded coordinates are stored as `latitude` and `longitude`
4. **Error Handling**: If geocoding fails, event is still created but without coordinates

#### Response

**Success (201 Created)**:
```json
{
  "success": true,
  "message": "Event published successfully",
  "event": {
    "id": 123,
    "title": "Tech Networking Meetup",
    "city": "San Francisco",
    "location": "SOMA District", 
    "address": "123 Technology Street, San Francisco, CA 94105",
    "latitude": "37.7749000",
    "longitude": "-122.4194000",
    "date": "2024-03-15T19:00:00.000Z",
    // ... other event fields
  }
}
```

### 2. Event Updates with Location

**Endpoint**: `PUT /api/events/:id`

**Content-Type**: `multipart/form-data`

**Authentication**: Required (must be event creator)

#### Location Update Logic

- **Re-geocoding Trigger**: Location coordinates are re-calculated if either `location` or `address` fields are modified
- **Geocoding Priority**: Same as creation - `address` field takes priority over `location` for geocoding
- **Coordinate Updates**: New latitude/longitude values replace existing ones

#### Example Request

```json
{
  "location": "Mission District",
  "address": "456 Mission Street, San Francisco, CA 94105"
}
```

### 3. Event Retrieval with Location Filtering

**Endpoint**: `GET /api/events`

**Method**: GET

**Authentication**: Optional (affects private event visibility)

#### Query Parameters

```
GET /api/events?city=San Francisco&location=Downtown&limit=20&offset=0
```

**Available Location Filters**:
- `city` (string): Filter by city name (exact match)
- `location` (string): Filter by specific location/venue name
- `limit` (number): Results per page (default: 20)
- `offset` (number): Pagination offset (default: 0)

**Other Filters**:
- `category` (string): Filter by event category
- `date` (string): Filter by date (YYYY-MM-DD format)
- `hostId` (number): Filter by event creator

#### Response Format

```json
{
  "events": [
    {
      "id": 123,
      "title": "Tech Meetup",
      "city": "San Francisco",
      "location": "SOMA District",
      "address": "123 Tech Street, San Francisco, CA 94105",
      "latitude": "37.7749000",
      "longitude": "-122.4194000",
      "date": "2024-03-15T19:00:00.000Z",
      "category": "Technology",
      "attendingCount": 15,
      "interestedCount": 8,
      // ... other event details
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 45,
    "hasMore": true
  }
}
```

## User Location Browsing

### User Browse with Location

**Endpoint**: `GET /api/users/browse`

#### Location-Based User Filtering

```
GET /api/users/browse?location=San Francisco&limit=10&offset=0
```

**Query Parameters**:
- `location` (string): Filter users by city/location (exact match)
- Other filters: `gender`, `minAge`, `maxAge`, `moods`, `interests`, `name`

## Data Types and Validation

### Coordinate Precision

- **Latitude Range**: -90.0000000 to 90.0000000 (7 decimal places)
- **Longitude Range**: -180.0000000 to 180.0000000 (7 decimal places)
- **Database Type**: `DECIMAL(10,7)` provides sufficient precision for location accuracy

### Location Field Validation

```typescript
// Validation Rules
{
  city: "required|string|max:100",
  location: "required|string|max:200", 
  address: "optional|string|max:500",
  latitude: "optional|decimal:-90,90",
  longitude: "optional|decimal:-180,180"
}
```

## Error Handling

### Geocoding Errors

**Scenario**: Mapbox API failure or invalid location
```json
{
  "warning": "Location could not be geocoded",
  "coordinates": null,
  "fallback": "Event created without precise coordinates"
}
```

**Impact**: 
- Event creation/update continues successfully
- Coordinates fields remain `null`
- Location-based proximity features won't work for this event

### Common Error Responses

**400 Bad Request - Invalid Location Data**:
```json
{
  "error": "Invalid event data",
  "details": [
    {
      "field": "city",
      "message": "City is required"
    },
    {
      "field": "location", 
      "message": "Location is required"
    }
  ]
}
```

**403 Forbidden - Update Permission**:
```json
{
  "error": "You can only edit your own events"
}
```

**404 Not Found - Event Not Found**:
```json
{
  "error": "Event not found"
}
```

## iOS Integration Guidelines

### 1. Location Input Handling

**Recommended Flow**:
```swift
// For event creation
struct EventLocation {
    let city: String           // Required: User selects from available cities
    let location: String       // Required: Venue name or area description
    let address: String?       // Optional: Full address for precise mapping
}
```

### 2. Coordinate Display

**Map Integration**:
- Use `latitude` and `longitude` from API responses for map pins
- Handle `null` coordinates gracefully (show city-level location instead)
- Implement fallback to city-level maps when precise coordinates unavailable

### 3. Location Search and Autocomplete

**Recommended Approach**:
- Implement city selection from available cities endpoint
- For addresses, consider client-side Mapbox integration for autocomplete
- Send complete address to backend for server-side geocoding consistency

### 4. Error Handling in iOS

```swift
// Handle geocoding failures gracefully
if event.latitude == nil || event.longitude == nil {
    // Fall back to city-level location display
    showCityLevelMap(city: event.city)
} else {
    // Show precise location on map
    showEventPin(lat: event.latitude!, lng: event.longitude!)
}
```

## Performance Considerations

### Geocoding Limits

- **Mapbox Free Tier**: 100,000 requests/month
- **Rate Limiting**: Built-in via Mapbox SDK
- **Caching**: Coordinates cached in database to avoid re-geocoding

### Optimization Tips

1. **Batch Operations**: Group location updates when possible
2. **Client Validation**: Validate location format before API calls
3. **Cached Responses**: Store frequently accessed location data locally
4. **Graceful Degradation**: Always handle missing coordinate data

## Testing

### Test Cases for iOS Integration

1. **Event Creation with Address**: Verify coordinates are populated
2. **Event Creation without Address**: Verify fallback to location field
3. **Invalid Location**: Verify event creates with null coordinates
4. **Location Updates**: Verify coordinates update when location changes
5. **Coordinate Display**: Verify map integration handles null coordinates

### Sample Test Data

```json
{
  "valid_location": {
    "city": "San Francisco",
    "location": "Union Square",
    "address": "333 Post Street, San Francisco, CA 94108"
  },
  "expected_coordinates": {
    "latitude": "37.7879700",
    "longitude": "-122.4074400"
  }
}
```

## Security Considerations

### API Key Protection

- **Server-Side Only**: Mapbox API key is never exposed to client applications
- **Environment Variables**: API key stored securely in server environment
- **Request Validation**: All geocoding requests validated server-side

### Location Privacy

- **Precise Coordinates**: Only stored when user provides specific address
- **Opt-out Capability**: Events can be created without precise coordinates
- **Data Retention**: Location data follows standard data retention policies

## Support and Troubleshooting

### Common Issues

1. **Missing Coordinates**: Check if MAPBOX_API_KEY is configured
2. **Incorrect Geocoding**: Verify address format and completeness
3. **Performance Issues**: Monitor Mapbox usage against rate limits

### Debug Information

The backend logs geocoding operations:
```
Geocoding location: 123 Main Street, San Francisco, CA
Geocoding successful: lat=37.7749, lng=-122.4194
```

### Support Resources

- **Mapbox Documentation**: https://docs.mapbox.com/api/search/geocoding/
- **Platform Issues**: Contact backend development team
- **API Questions**: Reference this documentation and the main API documentation

---

*Last Updated: August 19, 2025*
*Version: 1.0*
*Compatible with: Maly Backend API v2.x*