# Maly Data Flow Diagrams

## Overview

This document illustrates the key data flows within the Maly platform, showing how information moves between frontend, backend, database, and external services.

---

## 1. Authentication Flow

### User Registration
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           USER REGISTRATION FLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌──────────────┐     ┌─────────────┐     ┌────────────┐
│  User   │────▶│ SignupFlow   │────▶│ POST        │────▶│ Express    │
│ Browser │     │ Page (React) │     │ /api/register│    │ Server     │
└─────────┘     └──────────────┘     └─────────────┘     └──────┬─────┘
                                                                 │
                     ┌───────────────────────────────────────────┘
                     │
                     ▼
              ┌─────────────┐     ┌────────────────┐     ┌────────────┐
              │ Validate    │────▶│ Hash Password │────▶│ PostgreSQL │
              │ with Zod    │     │ with bcrypt   │     │ (users)    │
              └─────────────┘     └────────────────┘     └──────┬─────┘
                                                                 │
                     ┌───────────────────────────────────────────┘
                     │
                     ▼
              ┌─────────────┐     ┌────────────────┐     ┌────────────┐
              │ Create      │────▶│ Return User   │────▶│ Store in   │
              │ Session     │     │ Object        │     │ React Query│
              └─────────────┘     └────────────────┘     └────────────┘
```

### User Login
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USER LOGIN FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌─────────────┐     ┌─────────────┐
│  User   │────▶│ AuthPage    │────▶│ POST        │
│         │     │ (React)     │     │ /api/login  │
└─────────┘     └─────────────┘     └──────┬──────┘
                                           │
        ┌──────────────────────────────────┼──────────────────────────────────┐
        │                                  ▼                                  │
        │  ┌──────────────┐     ┌─────────────────┐     ┌─────────────────┐  │
        │  │ Passport.js  │────▶│ Verify bcrypt   │────▶│ PostgreSQL      │  │
        │  │ LocalStrategy│     │ Password Hash   │     │ users table     │  │
        │  └──────────────┘     └─────────────────┘     └─────────────────┘  │
        │                                                                      │
        │  ┌──────────────────────────────────────────────────────────────┐   │
        │  │                    SESSION CREATION                          │   │
        │  │  ┌─────────────┐     ┌──────────────┐     ┌──────────────┐   │   │
        │  │  │ Create      │────▶│ Store in     │────▶│ Return       │   │   │
        │  │  │ Session ID  │     │ connect-pg   │     │ Cookie       │   │   │
        │  │  └─────────────┘     └──────────────┘     └──────────────┘   │   │
        │  └──────────────────────────────────────────────────────────────┘   │
        │                                                                      │
        │  ┌──────────────────────────────────────────────────────────────┐   │
        │  │                    JWT CREATION (Mobile)                     │   │
        │  │  ┌─────────────┐     ┌──────────────┐     ┌──────────────┐   │   │
        │  │  │ Generate    │────▶│ Sign with    │────▶│ Return       │   │   │
        │  │  │ JWT Payload │     │ JWT_SECRET   │     │ Token        │   │   │
        │  │  └─────────────┘     └──────────────┘     └──────────────┘   │   │
        │  └──────────────────────────────────────────────────────────────┘   │
        └─────────────────────────────────────────────────────────────────────┘
```

---

## 2. Event Creation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           EVENT CREATION FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌────────────────┐
│ Creator │────▶│ CreateEvent    │────▶│ Upload Images  │
│         │     │ FlowPage       │     │ to Cloudinary  │
└─────────┘     └────────────────┘     └───────┬────────┘
                                               │
        ┌──────────────────────────────────────┘
        │
        ▼
┌───────────────┐     ┌────────────────┐     ┌─────────────────┐
│ POST          │────▶│ Validate with  │────▶│ Geocode Address │
│ /api/events   │     │ Zod Schema     │     │ via Mapbox      │
└───────────────┘     └────────────────┘     └────────┬────────┘
                                                      │
        ┌─────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐     ┌────────────────┐     ┌─────────────────┐
│ Insert into   │────▶│ Create Stripe  │────▶│ Store Product/  │
│ events table  │     │ Product (paid) │     │ Price IDs       │
└───────────────┘     └────────────────┘     └────────┬────────┘
                                                      │
        ┌─────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐     ┌────────────────┐
│ Invalidate    │────▶│ Push Notify    │
│ Query Cache   │     │ Matching Users │
└───────────────┘     └────────────────┘
```

---

## 3. Ticket Purchase Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TICKET PURCHASE FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌─────────────────────┐
│  User   │────▶│ EventPage      │────▶│ POST /api/payments/ │
│         │     │ (Buy Ticket)   │     │ create-checkout     │
└─────────┘     └────────────────┘     └──────────┬──────────┘
                                                   │
        ┌──────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         STRIPE CHECKOUT CREATION                             │
│                                                                              │
│  ┌────────────────┐     ┌────────────────┐     ┌────────────────────────┐   │
│  │ Validate Event │────▶│ Verify Creator │────▶│ Create Stripe          │   │
│  │ & Availability │     │ Connect Status │     │ Checkout Session       │   │
│  └────────────────┘     └────────────────┘     └────────────────────────┘   │
│                                                                              │
│  Checkout includes:                                                          │
│  • Line items with ticket price                                              │
│  • 3% application_fee_amount                                                 │
│  • transfer_data.destination = creator's Stripe account                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                                   │
        ┌──────────────────────────────────────────┘
        │
        ▼
┌───────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ Redirect to   │────▶│ User Completes  │────▶│ Stripe Webhook  │
│ Stripe        │     │ Payment         │     │ Received        │
└───────────────┘     └─────────────────┘     └────────┬────────┘
                                                       │
        ┌──────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         WEBHOOK PROCESSING                                   │
│                                                                              │
│  ┌────────────────┐     ┌────────────────┐     ┌────────────────────────┐   │
│  │ Record Payment │────▶│ Create Event   │────▶│ Generate QR            │   │
│  │ in payments    │     │ Participant    │     │ Ticket Code            │   │
│  │ table          │     │ Record         │     │                        │   │
│  └────────────────┘     └────────────────┘     └────────────────────────┘   │
│                                                                              │
│  ┌────────────────┐     ┌────────────────┐                                  │
│  │ Update         │────▶│ Send Push      │                                  │
│  │ availableTickets│    │ Notification   │                                  │
│  └────────────────┘     └────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. RSVP Flow with Group Chat

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          RSVP WITH GROUP CHAT FLOW                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌─────────────────────┐
│  User   │────▶│ EventPage      │────▶│ POST /api/events/   │
│         │     │ (Request RSVP) │     │ :id/applications    │
└─────────┘     └────────────────┘     └──────────┬──────────┘
                                                   │
        ┌──────────────────────────────────────────┘
        │
        ▼
┌───────────────┐     ┌────────────────────┐
│ Create        │────▶│ Notify Event       │
│ Participant   │     │ Host               │
│ status=pending│     │                    │
└───────────────┘     └────────────────────┘

        ... Host Reviews Application ...

┌─────────┐     ┌────────────────┐     ┌─────────────────────────────┐
│  Host   │────▶│ Applications   │────▶│ PUT /api/events/:id/        │
│         │     │ List           │     │ applications/:userId        │
└─────────┘     └────────────────┘     └──────────────┬──────────────┘
                                                       │
        ┌──────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         APPROVAL PROCESSING                                  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                    If status = 'approved'                          │     │
│  │                                                                    │     │
│  │  ┌────────────────┐     ┌─────────────────┐     ┌──────────────┐  │     │
│  │  │ Update         │────▶│ Get/Create      │────▶│ Add User to  │  │     │
│  │  │ Participant    │     │ Event Group     │     │ Conversation │  │     │
│  │  │ status         │     │ Conversation    │     │ Participants │  │     │
│  │  └────────────────┘     └─────────────────┘     └──────────────┘  │     │
│  │                                                                    │     │
│  │  ┌────────────────┐     ┌─────────────────┐                       │     │
│  │  │ Send Push      │────▶│ Notify User     │                       │     │
│  │  │ Notification   │     │ of Approval     │                       │     │
│  │  └────────────────┘     └─────────────────┘                       │     │
│  └────────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Messaging Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            MESSAGING FLOW                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────────────────────┐
                    │         MESSAGE SENDING               │
                    └───────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌─────────────────────────────┐
│ Sender  │────▶│ ChatDetail     │────▶│ POST /api/conversations/    │
│         │     │ Page           │     │ :id/messages                │
└─────────┘     └────────────────┘     └──────────────┬──────────────┘
                                                       │
        ┌──────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ┌────────────────┐     ┌────────────────┐     ┌────────────────────────┐   │
│  │ Insert into    │────▶│ WebSocket      │────▶│ Push Notification      │   │
│  │ messages table │     │ Broadcast      │     │ to Recipients          │   │
│  └────────────────┘     └────────────────┘     └────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────────────────────┐
                    │       REAL-TIME DELIVERY              │
                    └───────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────┐
│                                                                            │
│   ┌─────────┐         ┌─────────────┐         ┌─────────┐                 │
│   │ Sender  │◀───────▶│  WebSocket  │◀───────▶│Recipient│                 │
│   │ Browser │         │   Server    │         │ Browser │                 │
│   └─────────┘         └─────────────┘         └─────────┘                 │
│                              │                                             │
│                              │ Message Event                               │
│                              ▼                                             │
│                       ┌─────────────┐                                      │
│                       │ Update UI   │                                      │
│                       │ React Query │                                      │
│                       └─────────────┘                                      │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 6. AI Concierge Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          AI CONCIERGE FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌─────────────────┐
│  User   │────▶│ ChatbotPage    │────▶│ POST /api/chat  │
│         │     │ (Type message) │     │                 │
└─────────┘     └────────────────┘     └────────┬────────┘
                                                 │
        ┌────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        MESSAGE ANALYSIS                                    │
│                                                                            │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                 Is it an Event Query?                              │   │
│  │                                                                    │   │
│  │  Keywords: "events", "happening", "things to do", "going on"       │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                          │                    │                            │
│                    YES   │                    │   NO                       │
│                          ▼                    ▼                            │
│           ┌─────────────────────┐   ┌─────────────────────┐               │
│           │ Parse Event Params  │   │ Send to OpenAI      │               │
│           │ - City              │   │ for General         │               │
│           │ - Category          │   │ Response            │               │
│           │ - Date Range        │   │                     │               │
│           └──────────┬──────────┘   └──────────┬──────────┘               │
│                      │                         │                           │
│                      ▼                         │                           │
│           ┌─────────────────────┐             │                           │
│           │ Query PostgreSQL    │             │                           │
│           │ events table        │             │                           │
│           └──────────┬──────────┘             │                           │
│                      │                         │                           │
│                      ▼                         │                           │
│           ┌─────────────────────┐             │                           │
│           │ Format Events       │             │                           │
│           │ for AI Context      │             │                           │
│           └──────────┬──────────┘             │                           │
│                      │                         │                           │
│                      ▼                         ▼                           │
│           ┌───────────────────────────────────────────┐                   │
│           │           OpenAI API Call                 │                   │
│           │  - Include matching events in prompt      │                   │
│           │  - Generate natural language response     │                   │
│           └───────────────────────────────────────────┘                   │
└───────────────────────────────────────────────────────────────────────────┘
                                        │
        ┌───────────────────────────────┘
        │
        ▼
┌───────────────┐     ┌────────────────┐
│ Return        │────▶│ Display in     │
│ Response +    │     │ Chat UI        │
│ Event Cards   │     │                │
└───────────────┘     └────────────────┘
```

---

## 7. Premium Subscription Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       PREMIUM SUBSCRIPTION FLOW                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌─────────────────────────┐
│  User   │────▶│ PremiumPage    │────▶│ POST /api/premium/      │
│         │     │ (Select Plan)  │     │ create-checkout         │
└─────────┘     └────────────────┘     └────────────┬────────────┘
                                                     │
        ┌────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                     STRIPE SUBSCRIPTION CHECKOUT                           │
│                                                                            │
│  ┌────────────────┐     ┌─────────────────┐     ┌──────────────────────┐  │
│  │ Determine      │────▶│ Create Stripe   │────▶│ Redirect User        │  │
│  │ Price          │     │ Checkout        │     │ to Checkout          │  │
│  │ $29/mo or      │     │ Session         │     │                      │  │
│  │ $290/yr        │     │ (subscription   │     │                      │  │
│  │                │     │  mode)          │     │                      │  │
│  └────────────────┘     └─────────────────┘     └──────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
                                ┌───────────────┐
                                │ User Pays     │
                                │ on Stripe     │
                                └───────┬───────┘
                                        │
        ┌───────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                     POST-PAYMENT PROCESSING                                │
│                                                                            │
│  ┌────────────────┐     ┌─────────────────┐     ┌──────────────────────┐  │
│  │ GET /premium/  │────▶│ Verify Session  │────▶│ Update User          │  │
│  │ verify-checkout│     │ with Stripe     │     │ isPremium = true     │  │
│  └────────────────┘     └─────────────────┘     └──────────────────────┘  │
│                                                                            │
│  ┌────────────────┐     ┌─────────────────┐                               │
│  │ Create         │────▶│ Enable Premium  │                               │
│  │ Subscription   │     │ Features        │                               │
│  │ Record         │     │                 │                               │
│  └────────────────┘     └─────────────────┘                               │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Image Upload Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          IMAGE UPLOAD FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐     ┌────────────────┐     ┌─────────────────────────┐
│  User   │────▶│ EditProfile    │────▶│ POST /api/upload-       │
│         │     │ Page (Select   │     │ profile-images          │
│         │     │  images)       │     │ (multipart/form-data)   │
└─────────┘     └────────────────┘     └────────────┬────────────┘
                                                     │
        ┌────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       MULTER PROCESSING                                    │
│                                                                            │
│  ┌────────────────┐     ┌─────────────────┐     ┌──────────────────────┐  │
│  │ Parse          │────▶│ Validate        │────▶│ Store in             │  │
│  │ multipart      │     │ File Types      │     │ Memory Buffer        │  │
│  │ request        │     │ (jpg, png, etc) │     │                      │  │
│  └────────────────┘     └─────────────────┘     └──────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
                                        │
        ┌───────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       CLOUDINARY UPLOAD                                    │
│                                                                            │
│  ┌────────────────┐     ┌─────────────────┐     ┌──────────────────────┐  │
│  │ Upload to      │────▶│ Auto-optimize   │────▶│ Return CDN URL       │  │
│  │ Cloudinary     │     │ - Resize        │     │                      │  │
│  │                │     │ - Compress      │     │                      │  │
│  │                │     │ - Format        │     │                      │  │
│  └────────────────┘     └─────────────────┘     └──────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
                                        │
        ┌───────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       DATABASE UPDATE                                      │
│                                                                            │
│  ┌────────────────┐     ┌─────────────────┐     ┌──────────────────────┐  │
│  │ Update User    │────▶│ Return Updated  │────▶│ Update UI            │  │
│  │ profileImages  │     │ Image URLs      │     │ (React Query)        │  │
│  │ JSONB array    │     │                 │     │                      │  │
│  └────────────────┘     └─────────────────┘     └──────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Summary

| Flow | Primary Data Path | External Services |
|------|-------------------|-------------------|
| Auth | Browser → Express → PostgreSQL | - |
| Events | React → Express → PostgreSQL → Mapbox | Cloudinary, Stripe |
| Payments | React → Stripe Checkout → Webhook | Stripe |
| Messaging | React → Express/WebSocket → PostgreSQL | Web Push |
| AI Chat | React → Express → OpenAI → PostgreSQL | OpenAI |
| Media | React → Express → Cloudinary → PostgreSQL | Cloudinary |
